{% load static %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root {
        --primary: #2c3e50;
        --secondary: #34495e;
        --accent: #3498db;
        --success: #27ae60;
        --warning: #f39c12;
        --danger: #c0392b;
        --light: #ecf0f1;
        --card-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    /* Container */
    .dashboard-wrapper {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin-bottom: 40px;
    }

    /* 1. KPI KARTEN (Top Row) */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .kpi-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: transform 0.2s;
        border-left: 5px solid transparent;
    }
    .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }

    .kpi-content h3 { margin: 0; font-size: 12px; text-transform: uppercase; color: #7f8c8d; font-weight: 600; letter-spacing: 0.5px; }
    .kpi-content .value { font-size: 24px; font-weight: 700; color: var(--primary); margin-top: 5px; }
    .kpi-content .sub { font-size: 11px; color: #95a5a6; margin-top: 2px; }

    .kpi-icon {
        width: 50px; height: 50px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 20px;
    }

    /* Farben fÃ¼r Karten */
    .card-money { border-left-color: var(--success); }
    .card-money .kpi-icon { background: rgba(39, 174, 96, 0.1); color: var(--success); }

    .card-warn { border-left-color: var(--warning); }
    .card-warn .kpi-icon { background: rgba(243, 156, 18, 0.1); color: var(--warning); }

    .card-danger { border-left-color: var(--danger); }
    .card-danger .kpi-icon { background: rgba(192, 57, 43, 0.1); color: var(--danger); }

    .card-info { border-left-color: var(--accent); }
    .card-info .kpi-icon { background: rgba(52, 152, 219, 0.1); color: var(--accent); }

    /* 2. MAIN GRID (Chart + Listen) */
    .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr; /* Links breit, rechts schmaler */
        gap: 20px;
    }
    @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

    .content-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--card-shadow);
    }
    .content-card h2 { margin-top: 0; font-size: 16px; color: var(--secondary); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }

    /* Tabellen Styling */
    .dash-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .dash-table th { text-align: left; color: #95a5a6; font-weight: 600; padding: 8px 0; border-bottom: 1px solid #eee; }
    .dash-table td { padding: 10px 0; border-bottom: 1px solid #f9f9f9; color: var(--primary); }
    .dash-table tr:last-child td { border-bottom: none; }

    .badge { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; color: white; }
    .bg-hoch { background: var(--danger); }
    .bg-mittel { background: var(--warning); }
    .bg-niedrig { background: var(--success); }

    .btn-small { display: inline-block; padding: 4px 10px; background: var(--light); color: var(--secondary); border-radius: 4px; text-decoration: none; font-size: 11px; margin-top: 10px; }
    .btn-small:hover { background: #ddd; }
</style>

<div class="dashboard-wrapper">

    <div class="kpi-grid">
        <div class="kpi-card card-money">
            <div class="kpi-content">
                <h3>Soll-Miete</h3>
                <div class="value">CHF {{ total_miete }}</div>
                <div class="sub">pro Monat</div>
            </div>
            <div class="kpi-icon"><i class="fa-solid fa-sack-dollar"></i></div>
        </div>

        <div class="kpi-card {% if leerstand_count > 0 %}card-warn{% else %}card-money{% endif %}">
            <div class="kpi-content">
                <h3>Leerstand</h3>
                <div class="value">{{ leerstand_count }} Einheiten</div>
                <div class="sub">Quote: {{ leerstand_prozent }}%</div>
            </div>
            <div class="kpi-icon"><i class="fa-solid fa-house-chimney-crack"></i></div>
        </div>

        <div class="kpi-card {% if offene_tickets_count > 0 %}card-danger{% else %}card-money{% endif %}">
            <div class="kpi-content">
                <h3>Offene Tickets</h3>
                <div class="value">{{ offene_tickets_count }}</div>
                <div class="sub">Handlungsbedarf</div>
            </div>
            <div class="kpi-icon"><i class="fa-solid fa-screwdriver-wrench"></i></div>
        </div>

        <div class="kpi-card card-info">
            <div class="kpi-content">
                <h3>Portfolio</h3>
                <div class="value">{{ total_objekte }}</div>
                <div class="sub">Liegenschaften</div>
            </div>
            <div class="kpi-icon"><i class="fa-solid fa-building"></i></div>
        </div>
    </div>

    <div class="main-grid">

        <div class="content-card">
            <h2><i class="fa-solid fa-chart-simple"></i> Umsatz-Verteilung</h2>
            <div style="height: 250px;">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <div class="v-stack" style="display:flex; flex-direction:column; gap:20px;">

            <div class="content-card">
                <h2><i class="fa-solid fa-bell"></i> Neueste Tickets</h2>
                {% if neueste_tickets %}
                    <table class="dash-table">
                        <thead><tr><th>Titel</th><th>Prio</th><th></th></tr></thead>
                        <tbody>
                            {% for t in neueste_tickets %}
                            <tr>
                                <td>{{ t.titel|truncatechars:20 }}<br><span style="color:#999; font-size:10px;">{{ t.liegenschaft.strasse }}</span></td>
                                <td><span class="badge bg-{{ t.prioritaet }}">{{ t.prioritaet }}</span></td>
                                <td style="text-align:right;"><a href="{% url 'admin:core_schadenmeldung_change' t.id %}" target="_blank">âžœ</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p style="color:#999; font-size:13px;">Keine offenen Tickets. Gute Arbeit! ðŸŽ‰</p>
                {% endif %}
            </div>

            {% if leerstaende_liste %}
            <div class="content-card" style="border-top: 4px solid var(--warning);">
                <h2><i class="fa-solid fa-triangle-exclamation"></i> LeerstÃ¤nde</h2>
                <table class="dash-table">
                    <tbody>
                        {% for unit in leerstaende_liste %}
                        <tr>
                            <td><b>{{ unit.bezeichnung }}</b><br><span style="color:#999; font-size:10px;">{{ unit.liegenschaft.strasse }}</span></td>
                            <td style="text-align:right;"><a href="{% url 'admin:core_einheit_change' unit.id %}" class="btn-small">Vermieten</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

        </div>
    </div>
</div>

<script>
    const ctx = document.getElementById('revenueChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [{
                label: 'Soll-Miete (CHF)',
                data: {{ chart_data|safe }},
                backgroundColor: '#3498db',
                borderRadius: 4,
                barThickness: 30
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
                x: { grid: { display: false } }
            }
        }
    });
</script>