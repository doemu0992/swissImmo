{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrahead %}{{ block.super }}
<style>
    /* 1. RESET: Standard Django Layout √ºberschreiben */
    #content-main {
        margin: 0 !important; padding: 0 !important; width: 100% !important; max-width: 100% !important;
        height: 85vh !important; float: none !important; display: flex !important; flex-direction: column !important;
    }
    form { height: 100%; display: flex !important; flex-direction: column !important; width: 100%; }

    /* 2. LAYOUT CONTAINER */
    #app-layout {
        display: flex !important; flex: 1; background: #fff; border: 1px solid #ccc;
        overflow: hidden; flex-direction: row !important; width: 100%;
    }

    /* SPALTE 2: MEN√ú (Grau) */
    .col-menu {
        width: 260px !important; min-width: 260px !important; background-color: #f2f4f7 !important;
        border-right: 1px solid #dce2e6; display: flex; flex-direction: column; overflow-y: auto;
    }
    .menu-header { padding: 15px; font-weight: bold; color: #555; font-size: 11px; text-transform: uppercase; border-bottom: 1px solid #dce2e6; letter-spacing: 1px; }

    /* Tabs */
    .nav-btn { padding: 12px 20px; cursor: pointer; color: #333; border-left: 4px solid transparent; border-bottom: 1px solid #e6e6e6; font-size: 13px; transition: all 0.2s; }
    .nav-btn:hover { background-color: #e6f0fa; color: #0056b3; }
    .nav-btn.active { background-color: #ffffff !important; border-left-color: #0056b3 !important; color: #0056b3 !important; font-weight: 700; border-right: 1px solid transparent; margin-right: -1px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    /* SPALTE 3: INHALT (Wei√ü) */
    .col-content { flex-grow: 1 !important; padding: 30px 40px; overflow-y: auto; background-color: #fff; width: 100%; }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadein 0.3s; }
    @keyframes fadein { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* STYLES */
    .form-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px dotted #eee; }
    .form-row label { width: 220px; color: #666; font-size: 12px; font-weight: normal; }
    .form-row input, .form-row select, .form-row textarea { padding: 6px; border: 1px solid #ccc; border-radius: 3px; width: 350px; font-size: 13px; }
    .form-row input:focus { border-color: #0056b3; outline: none; }

    .section-title { font-size: 16px; color: #2c3e50; margin-top: 0; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
    .top-toolbar { background: #fff; padding: 10px 20px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; height: 50px; flex-shrink: 0; }
    .btn-save { background: #28a745; color: white; border: none; padding: 8px 20px; border-radius: 3px; cursor: pointer; font-size: 13px; font-weight: bold;}

    .errornote { color: red; background: #ffebee; padding: 10px; border: 1px solid red; margin: 10px; }
</style>

<script>
    function openTab(index) {
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));

        document.getElementById('nav-' + index).classList.add('active');
        document.getElementById('content-' + index).classList.add('active');
    }
</script>
{% endblock %}

{% block content %}
<div id="content-main">
    <form {% if has_file_field %}enctype="multipart/form-data" {% endif %}action="{{ form_url }}" method="post" id="{{ opts.model_name }}_form" novalidate>
    {% csrf_token %}

    <div class="top-toolbar">
        <div style="font-size:16px; font-weight:bold; color:#333; display:flex; align-items:center;">
            {% if original %}‚úèÔ∏è {{ original|truncatechars:50 }}{% else %}‚ûï Neu: {{ opts.verbose_name }}{% endif %}
        </div>
        <div style="display:flex; gap:10px;">
            {% block object-tools-items %}
                {% if original and opts.model_name == 'mietvertrag' %}
                     <a href="{% url 'generate_pdf' original.pk %}" target="_blank" style="padding:8px 15px; background:#6c757d; color:white; text-decoration:none; border-radius:3px; font-size:13px; font-weight:bold; margin-right:5px;">
                        üñ®Ô∏è PDF Vorschau
                     </a>

                     {% if original.mieter.email %}
                         <a href="{% url 'send_docuseal' original.pk %}" style="padding:8px 15px; background:#ff6b00; color:white; text-decoration:none; border-radius:3px; font-size:13px; font-weight:bold;">
                            ‚úçÔ∏è Via DocuSeal Sign
                         </a>
                     {% else %}
                        <span style="padding:8px 15px; background:#ddd; color:#999; border-radius:3px; font-size:13px; font-weight:bold; cursor:not-allowed;" title="Mieter hat keine E-Mail">
                            ‚úçÔ∏è Keine E-Mail
                        </span>
                     {% endif %}
                {% endif %}
            {% endblock %}
            <button type="submit" name="_continue" class="btn-save">üíæ SPEICHERN</button>
        </div>
    </div>

    {% if errors %}
        <div class="errornote">‚ö†Ô∏è Bitte korrigieren Sie die Fehler in den markierten Tabs.</div>
    {% endif %}

    <div id="app-layout">
        <div class="col-menu">
            <div class="menu-header">Daten-Bereiche</div>

            {% for fieldset in adminform %}
                <div id="nav-fs-{{ forloop.counter0 }}" class="nav-btn {% if forloop.first %}active{% endif %}" onclick="openTab('fs-{{ forloop.counter0 }}')">
                    {{ fieldset.name|default:"Allgemein" }}
                </div>
            {% endfor %}

            {% if inline_admin_formsets %}
                <div class="menu-header" style="margin-top:20px;">Listen & Details</div>
                {% for inline_admin_formset in inline_admin_formsets %}
                    <div id="nav-in-{{ forloop.counter0 }}" class="nav-btn" onclick="openTab('in-{{ forloop.counter0 }}')">
                        üìã {{ inline_admin_formset.opts.verbose_name_plural|capfirst }}
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="col-content">

            {% for fieldset in adminform %}
                <div id="content-fs-{{ forloop.counter0 }}" class="tab-content {% if forloop.first %}active{% endif %}">
                    <h2 class="section-title">{{ fieldset.name|default:"Allgemeine Angaben" }}</h2>
                    {% if fieldset.description %}
                        <div style="margin-bottom:15px; background:#fff3cd; padding:10px; border-left:4px solid #ffc107;">{{ fieldset.description|safe }}</div>
                    {% endif %}

                    {% for line in fieldset %}
                        {% for field in line %}
                            <div class="form-row">
                                <label>{{ field.field.label }}</label>
                                <div>
                                    {{ field.field }}
                                    {% if field.field.errors %}<div style="color:red; font-size:11px; font-weight:bold;">{{ field.field.errors|striptags }}</div>{% endif %}
                                    {% if field.field.help_text %}<div style="color:#999; font-size:10px; margin-top:2px;">{{ field.field.help_text|safe }}</div>{% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    {% endfor %}
                </div>
            {% endfor %}

            {% for inline_admin_formset in inline_admin_formsets %}
                <div id="content-in-{{ forloop.counter0 }}" class="tab-content">
                    <h2 class="section-title">{{ inline_admin_formset.opts.verbose_name_plural|capfirst }}</h2>
                    {% include inline_admin_formset.opts.template %}
                </div>
            {% endfor %}

        </div>
    </div>
    </form>
</div>
{% endblock %}