<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immobilien Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; color: #333; }

        /* Dashboard Grid */
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 4px solid #3498db; }
        .stat-card h3 { margin: 0 0 5px 0; font-size: 14px; color: #777; text-transform: uppercase; }
        .stat-card .value { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .stat-card.alert { border-left-color: #e74c3c; }
        .stat-card.success { border-left-color: #2ecc71; }

        /* Tree View Styling */
        .tree-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; color: #2c3e50; }

        ul.tree { list-style-type: none; padding-left: 20px; }
        ul.tree li { margin: 5px 0; position: relative; }

        .tree-item { display: inline-block; padding: 5px 10px; border-radius: 4px; text-decoration: none; color: #333; transition: background 0.2s; }
        .tree-item:hover { background-color: #f0f0f0; }

        .lvl-mandant { font-weight: bold; font-size: 1.1em; color: #2c3e50; }
        .lvl-liegenschaft { font-weight: 600; color: #34495e; }
        .lvl-einheit { color: #555; }

        /* Buttons & Icons */
        .icon { margin-right: 5px; }
        .add-btn { display: inline-block; width: 20px; height: 20px; text-align: center; line-height: 20px; border-radius: 50%; color: white; font-weight: bold; font-size: 12px; margin-left: 5px; text-decoration: none; opacity: 0.6; transition: opacity 0.2s; }
        .add-btn:hover { opacity: 1; }
        .btn-green { background-color: #27ae60; } /* Neuer Vertrag */
        .btn-orange { background-color: #e67e22; } /* Leerstand */

        /* Details & Nested Lists */
        .nested { margin-left: 20px; border-left: 1px solid #ddd; padding-left: 10px; }
    </style>
</head>
<body>

    <div class="dashboard-stats">
        <div class="stat-card">
            <h3>Soll-Miete (Total)</h3>
            <div class="value">CHF {{ total_soll|floatformat:2 }}</div>
        </div>
        <div class="stat-card alert">
            <h3>Leerst√§nde</h3>
            <div class="value">{{ leerstand_count }}</div>
        </div>
        <div class="stat-card {% if offene_schaden > 0 %}alert{% else %}success{% endif %}">
            <h3>Offene Sch√§den</h3>
            <div class="value">{{ offene_schaden }}</div>
        </div>
        <div class="stat-card">
            <h3>Liegenschaften</h3>
            <div class="value">{{ total_liegenschaften }}</div>
        </div>
    </div>

    <div class="tree-container">
        <h2>Portfolio √úbersicht</h2>

        <ul class="tree">
            {% for mandant in baum_daten %}
                <li>
                    <a href="/admin/core/mandant/{{ mandant.id }}/change/" class="tree-item lvl-mandant">
                        üè¢ {{ mandant.firma_oder_name }}
                    </a>

                    <ul class="nested">
                        {% for liegenschaft in mandant.liegenschaften.all %}
                            <li>
                                <a href="/admin/core/liegenschaft/{{ liegenschaft.id }}/change/" class="tree-item lvl-liegenschaft">
                                    üè† {{ liegenschaft.strasse }}, {{ liegenschaft.ort }}
                                </a>

                                <ul class="nested">
                                    {% for einheit in liegenschaft.einheiten.all %}
                                        <li>
                                            <div style="display:flex; align-items:center;">
                                                <a href="/admin/core/einheit/{{ einheit.id }}/change/" class="tree-item lvl-einheit">
                                                    üö™ {{ einheit.bezeichnung }} <span style="font-size:0.8em; color:#999;">({{ einheit.get_typ_display }})</span>
                                                </a>

                                                <a href="/admin/core/mietvertrag/add/?einheit={{ einheit.id }}" class="add-btn btn-green" title="Neuer Mietvertrag" onclick="event.stopPropagation();">+</a>
                                                <a href="/admin/core/leerstand/add/?einheit={{ einheit.id }}" class="add-btn btn-orange" title="Leerstand erfassen" onclick="event.stopPropagation();">L</a>
                                            </div>

                                            <ul class="nested" style="border-left: 1px dashed #ccc;">
                                                {% for item in einheit.verhaeltnisse %}
                                                    <li style="margin-top:2px;">
                                                        {% if item.is_mietvertrag %}
                                                            <div style="display:flex; align-items:center;">
                                                                <a href="/admin/core/mietvertrag/{{ item.id }}/change/" class="tree-item lvl-detail" style="flex-grow:1; {% if item.aktiv %}color:green;{% else %}color:#ccc; text-decoration:line-through;{% endif %}">
                                                                    <span class="icon">üë§</span> {{ item.mieter }} <span style="font-size:0.85em; color:#888;">(ab {{ item.beginn|date:"d.m.y" }})</span>
                                                                </a>

                                                                <a href="{% url 'generate_pdf' item.id %}" target="_blank" title="Mietvertrag als PDF drucken" style="text-decoration:none; margin-right:5px; font-size: 1.2em;">üñ®Ô∏è</a>

                                                                {% if item.sign_status == 'offen' %}
                                                                    <a href="{% url 'send_docuseal' item.id %}" title="Via DocuSeal senden" style="text-decoration:none; font-size: 1.2em;">üì®</a>
                                                                {% endif %}
                                                            </div>
                                                        {% else %}
                                                            <a href="/admin/core/leerstand/{{ item.id }}/change/" class="tree-item lvl-detail" style="color:#d35400;">
                                                                <span class="icon">‚è≥</span> <i>{{ item.get_grund_display }}</i> <span style="font-size:0.85em;">(ab {{ item.beginn|date:"d.m.y" }})</span>
                                                            </a>
                                                        {% endif %}
                                                    </li>
                                                {% empty %}
                                                    <li><span class="tree-item" style="color:red; font-size:0.85em;">‚ö†Ô∏è Keine Daten</span></li>
                                                {% endfor %}
                                            </ul>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </li>
                        {% endfor %}
                    </ul>
                </li>
            {% endfor %}
        </ul>
    </div>

</body>
</html>